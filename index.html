<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="mb-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-4xl font-semibold tracking-tight mb-1">
          Broker Consensus Dashboard
        </h1>
        <p class="text-1xl text-slate-300">
          Compare companies on Growth, Valuation, Margin Expansion and GSM. Filters reset on refresh.
        </p>
      </div>

      <!-- Top-right logo (replace src with your actual logo path) -->
      <div class="mt-2 md:mt-0">
        <img
          src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png"
          alt="Purnartha Logo"
          class="h-24 w-auto object-contain"
        />
      </div>
    </header>

    <!-- Top controls: Sector + Sub-Sector + Market Cap + Period + Download button -->
    <div class="mb-4 flex flex-wrap items-center gap-3 text-xs">
      <!-- Sector -->
      <div class="text-sm flex items-center gap-2">
        <span class="text-slate-300">Sector:</span>
        <select
          id="sector-select"
          class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs"
        ></select>
      </div>

      <!-- Sub-Sector -->
      <div class="text-sm flex items-center gap-2">
        <span class="text-slate-300">Sub-Sector:</span>
        <select
          id="subsector-select"
          class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs"
        ></select>
      </div>

      <!-- Market Cap -->
      <div class="text-sm flex items-center gap-2">
        <span class="text-slate-300">Market Cap:</span>
        <select
          id="marketcap-select"
          class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs"
        ></select>
      </div>

      <!-- Period -->
      <div class="flex items-center gap-2">
        <span class="text-sm text-slate-300">Period:</span>
        <select
          id="period-select"
          class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs"
        >
          <option value="FY1" selected>FY1</option>
          <option value="FY2">FY2</option>
          <option value="FY3">FY3</option>
          <option value="2Y">2-Year</option>
          <option value="3Y">3-Year</option>
        </select>
        <span
          id="period-help"
          class="text-slate-400 text-[12px]"
        ></span>
      </div>

      <!-- Download button (right aligned) -->
      <div class="ml-auto">
        <button
          id="download-excel"
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-xs font-medium shadow-sm"
        >
          Download Excel
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4 border-b border-slate-800">
      <nav class="flex gap-4 text-sm">
        <button
          class="tab-btn py-2 border-b-2 border-emerald-500 text-emerald-400"
          data-tab="growth"
        >
          Growth
        </button>
        <button
          class="tab-btn py-2 border-b-2 border-transparent text-slate-300 hover:text-slate-100"
          data-tab="valuation"
        >
          Valuation
        </button>
        <button
          class="tab-btn py-2 border-b-2 border-transparent text-slate-300 hover:text-slate-100"
          data-tab="margin"
        >
          Margin Expansion
        </button>
        <button
          class="tab-btn py-2 border-b-2 border-transparent text-slate-300 hover:text-slate-100"
          data-tab="gsm"
        >
          GSM
        </button>
      </nav>
    </div>

    <!-- ===================================================== -->
    <!-- GROWTH TAB -->
    <!-- ===================================================== -->
    <div id="tab-growth">
      <div class="mb-3 text-xs text-slate-400">
        Defaults: Revenue ≥ 20%, EBITDA ≥ 20%, EPS ≥ 20%.
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 text-xs">
        <!-- Revenue Growth -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="growth-revenue">
          <h2 class="text-lg font-semibold mb-2">Revenue Growth</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="growth-rev-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=" selected>&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=">&le;</option>
            </select>
            <input id="growth-rev-threshold"
                   type="number" step="0.1" value="20"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Growth</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="growth-rev-body"></tbody>
            </table>
          </div>
        </section>

        <!-- EBITDA Growth -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="growth-ebitda">
          <h2 class="text-lg font-semibold mb-2">EBITDA Growth</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="growth-ebitda-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=" selected>&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=">&le;</option>
            </select>
            <input id="growth-ebitda-threshold"
                   type="number" step="0.1" value="20"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Growth</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="growth-ebitda-body"></tbody>
            </table>
          </div>
        </section>

        <!-- EPS Growth -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="growth-eps">
          <h2 class="text-lg font-semibold mb-2">EPS Growth</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="growth-eps-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=" selected>&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=">&le;</option>
            </select>
            <input id="growth-eps-threshold"
                   type="number" step="0.1" value="20"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Growth</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="growth-eps-body"></tbody>
            </table>
          </div>
        </section>

        <!-- Growth Summary -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="growth-summary">
          <h2 class="text-lg font-semibold mb-2">Growth Summary</h2>

          <div class="mb-3 text-xs text-slate-400">
            Companies passing all three filters above.
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Rev G</th>
                  <th class="pr-2 text-center">EBITDA G</th>
                  <th class="pr-2 text-center">EPS G</th>
                </tr>
              </thead>
              <tbody id="growth-summary-body"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- VALUATION TAB -->
    <!-- ===================================================== -->
    <div id="tab-valuation" style="display:none;">
      <div class="mb-3 text-xs text-slate-400">
        Defaults: PE ≤ 30, P/B ≤ 5, P/S ≤ 5.
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-xs">
        <!-- PE -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="valuation-pe">
          <h2 class="text-lg font-semibold mb-2">PE</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="val-pe-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=">&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=" selected>&le;</option>
            </select>
            <input id="val-pe-threshold"
                   type="number" step="0.1" value="30"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">PE</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="val-pe-body"></tbody>
            </table>
          </div>
        </section>

        <!-- P/B -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="valuation-pb">
          <h2 class="text-lg font-semibold mb-2">P/B</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="val-pb-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=">&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=" selected>&le;</option>
            </select>
            <input id="val-pb-threshold"
                   type="number" step="0.1" value="5"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">P/B</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="val-pb-body"></tbody>
            </table>
          </div>
        </section>

        <!-- P/S -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="valuation-ps">
          <h2 class="text-lg font-semibold mb-2">P/S</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="val-ps-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=">&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=" selected>&le;</option>
            </select>
            <input id="val-ps-threshold"
                   type="number" step="0.1" value="5"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">P/S</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="val-ps-body"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- MARGIN EXPANSION TAB -->
    <!-- ===================================================== -->
    <div id="tab-margin" style="display:none;">
      <div class="mb-3 text-xs text-slate-400">
        Defaults: EBITDA ≥ 2%, PAT ≥ 2%.
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 text-xs">
        <!-- EBITDA Margin Expansion -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="margin-ebitda">
          <h2 class="text-lg font-semibold mb-2">EBITDA Margin Expansion</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="margin-ebitda-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=" selected>&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=">&le;</option>
            </select>
            <input id="margin-ebitda-threshold"
                   type="number" step="0.1" value="2"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Margin Exp</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="margin-ebitda-body"></tbody>
            </table>
          </div>
        </section>

        <!-- PAT Margin Expansion -->
        <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col"
                 data-section="margin-pat">
          <h2 class="text-lg font-semibold mb-2">PAT Margin Expansion</h2>

          <div class="flex items-center gap-2 mb-3">
            <span class="text-slate-300">Filter:</span>
            <select id="margin-pat-op"
                    class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5">
              <option value=">">&gt;</option>
              <option value=">=" selected>&ge;</option>
              <option value="<">&lt;</option>
              <option value="<=">&le;</option>
            </select>
            <input id="margin-pat-threshold"
                   type="number" step="0.1" value="2"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>

          <div class="overflow-auto flex-1">
            <table class="min-w-full text-left border-separate border-spacing-y-1">
              <thead class="text-slate-400">
                <tr>
                  <th class="pr-2">Company</th>
                  <th class="pr-2 text-center">Margin Exp</th>
                  <th class="pr-2 text-center">Sector Median</th>
                  <th class="pr-2 text-center">Diff.</th>
                </tr>
              </thead>
              <tbody id="margin-pat-body"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- GSM TAB -->
    <!-- ===================================================== -->
    <div id="tab-gsm" style="display:none;">
      <div class="mb-3 text-xs text-slate-400">
        Defaults: (Rev ≥ 15% OR EPS ≥ 15%) AND PE ≤ 25.
      </div>

      <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 text-xs"
               data-section="gsm">
        <h2 class="text-lg font-semibold mb-2">Growth + PE</h2>

        <div class="flex flex-wrap items-center gap-4 mb-3">
          <div class="flex items-center gap-2">
            <span class="text-slate-300">Rev Growth ≥</span>
            <input id="gsm-rev-threshold" type="number" step="0.1" value="15"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-slate-300">EPS Growth ≥</span>
            <input id="gsm-eps-threshold" type="number" step="0.1" value="15"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
            <span class="text-slate-400">%</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-slate-300">PE ≤</span>
            <input id="gsm-pe-threshold" type="number" step="0.1" value="25"
                   class="bg-slate-800 border border-slate-700 rounded px-1 py-0.5 w-16" />
          </div>
        </div>

        <div class="overflow-auto">
          <table class="min-w-full text-left border-separate border-spacing-y-1">
            <thead class="text-slate-400">
              <tr id="gsm-header-row"></tr>
            </thead>
            <tbody id="gsm-body"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    let allRows = [];
    let currentTab = "growth";

    // Sector -> SubSector mapping
    let sectorToSubSectors = {};

    // ---------------- HELPERS ----------------
    function fmtNum(val) {
      if (val == null || isNaN(val)) return "–";
      return val.toFixed(2);
    }
    function fmtPct(val) {
      if (val == null || isNaN(val)) return "–";
      return val.toFixed(2) + "%";
    }

    function passComparator(value, op, threshold) {
      if (value == null || isNaN(value)) return false;
      const t = parseFloat(threshold);
      if (isNaN(t)) return false;
      switch (op) {
        case ">": return value > t;
        case ">=": return value >= t;
        case "<": return value < t;
        case "<=": return value <= t;
        default: return false;
      }
    }

    function getCurrentSector() {
      const val = document.getElementById("sector-select").value;
      return val === "All" ? null : val;
    }

    function getCurrentSubSector() {
      const val = document.getElementById("subsector-select").value;
      return val === "All" ? null : val;
    }

    function getCurrentMarketCap() {
      const val = document.getElementById("marketcap-select").value;
      return val === "All" ? null : val;
    }

    function getCurrentPeriodKey() {
      return document.getElementById("period-select").value;
    }

    function updatePeriodLabel() {
      const pKey = getCurrentPeriodKey();
      const helpEl = document.getElementById("period-help");
      if (currentTab === "valuation") {
        if (pKey === "2Y") {
          helpEl.textContent = "(2-Year Avg)";
        } else if (pKey === "3Y") {
          helpEl.textContent = "(3-Year Avg)";
        } else {
          helpEl.textContent = "";
        }
      } else {
        if (pKey === "2Y") {
          helpEl.textContent = "(2-Year CAGR)";
        } else if (pKey === "3Y") {
          helpEl.textContent = "(3-Year CAGR)";
        } else {
          helpEl.textContent = "";
        }
      }
    }

    // Get filtered rows based on Sector, Sub-Sector, and Market Cap
    function getFilteredRows() {
      const sector = getCurrentSector();
      const subSector = getCurrentSubSector();
      const marketCap = getCurrentMarketCap();

      return allRows.filter(r => {
        // Filter by Sector
        if (sector && r.Sector !== sector) return false;
        // Filter by Sub-Sector
        if (subSector && r.Sub_Sector !== subSector) return false;
        // Filter by Market Cap
        if (marketCap && r.Market_Cap !== marketCap) return false;
        return true;
      });
    }

    // Build Sector -> SubSector mapping
    function buildSectorSubSectorMapping() {
      sectorToSubSectors = {};
      allRows.forEach(r => {
        if (r.Sector && r.Sub_Sector) {
          if (!sectorToSubSectors[r.Sector]) {
            sectorToSubSectors[r.Sector] = new Set();
          }
          sectorToSubSectors[r.Sector].add(r.Sub_Sector);
        }
      });
    }

    // Get SubSector's parent Sector
    function getSectorForSubSector(subSector) {
      for (const sector in sectorToSubSectors) {
        if (sectorToSubSectors[sector].has(subSector)) {
          return sector;
        }
      }
      return null;
    }

    // Update SubSector dropdown based on selected Sector
    function updateSubSectorDropdown() {
      const sector = getCurrentSector();
      const subSectorSelect = document.getElementById("subsector-select");
      const currentSubSector = subSectorSelect.value;

      let subSectors = [];
      if (sector) {
        // Show only sub-sectors for selected sector
        subSectors = sectorToSubSectors[sector] ? Array.from(sectorToSubSectors[sector]).sort() : [];
      } else {
        // Show all sub-sectors
        const allSubSectors = new Set();
        allRows.forEach(r => {
          if (r.Sub_Sector) allSubSectors.add(r.Sub_Sector);
        });
        subSectors = Array.from(allSubSectors).sort();
      }

      subSectorSelect.innerHTML = `<option value="All" selected>All</option>` +
        subSectors.map(s => `<option value="${s}">${s}</option>`).join("");

      // Try to maintain previous selection if it's still valid
      if (currentSubSector !== "All" && subSectors.includes(currentSubSector)) {
        subSectorSelect.value = currentSubSector;
      }
    }

    // ---------------- TABS ----------------
    function setupTabs() {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          currentTab = tab;

          document.querySelectorAll(".tab-btn").forEach(b => {
            b.classList.remove("border-emerald-500", "text-emerald-400");
            b.classList.add("border-transparent", "text-slate-300");
          });
          btn.classList.add("border-emerald-500", "text-emerald-400");
          btn.classList.remove("border-transparent", "text-slate-300");

          ["growth", "valuation", "margin", "gsm"].forEach(t => {
            document.getElementById("tab-" + t).style.display = t === tab ? "block" : "none";
          });

          updatePeriodLabel();
          renderAll();
        });
      });
    }

    function renderAll() {
      if (currentTab === "growth") {
        renderGrowth();
      } else if (currentTab === "valuation") {
        renderValuation();
      } else if (currentTab === "margin") {
        renderMargin();
      } else if (currentTab === "gsm") {
        renderGsm();
      }
    }

    // ---------------- GROWTH FILTERS ----------------
    function getGrowthFilterState() {
      return {
        rev: {
          op: document.getElementById("growth-rev-op").value,
          threshold: parseFloat(document.getElementById("growth-rev-threshold").value) || 0,
        },
        ebitda: {
          op: document.getElementById("growth-ebitda-op").value,
          threshold: parseFloat(document.getElementById("growth-ebitda-threshold").value) || 0,
        },
        eps: {
          op: document.getElementById("growth-eps-op").value,
          threshold: parseFloat(document.getElementById("growth-eps-threshold").value) || 0,
        },
      };
    }

    // ---------- GROWTH ----------
    function renderGrowth() {
      const filters = getGrowthFilterState();
      const rows = getFilteredRows();
      const periodKey = getCurrentPeriodKey();

      // Determine columns
      let revCol, ebitdaCol, epsCol, revMedCol, ebitdaMedCol, epsMedCol;
      if (periodKey === "2Y") {
        revCol = "Rev_G_CAGR2";
        ebitdaCol = "EBITDA_G_CAGR2";
        epsCol = "EPS_G_CAGR2";
        revMedCol = "Sub_Sector_Med_Rev_G_CAGR2";
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_G_CAGR2";
        epsMedCol = "Sub_Sector_Med_EPS_G_CAGR2";
      } else if (periodKey === "3Y") {
        revCol = "Rev_G_CAGR3";
        ebitdaCol = "EBITDA_G_CAGR3";
        epsCol = "EPS_G_CAGR3";
        revMedCol = "Sub_Sector_Med_Rev_G_CAGR3";
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_G_CAGR3";
        epsMedCol = "Sub_Sector_Med_EPS_G_CAGR3";
      } else {
        revCol = "Rev_G_" + periodKey;
        ebitdaCol = "EBITDA_G_" + periodKey;
        epsCol = "EPS_G_" + periodKey;
        revMedCol = "Sub_Sector_Med_Rev_G_" + periodKey;
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_G_" + periodKey;
        epsMedCol = "Sub_Sector_Med_EPS_G_" + periodKey;
      }

      // Revenue
      const revBody = document.getElementById("growth-rev-body");
      revBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[revCol], filters.rev.op, filters.rev.threshold))
        .sort((a, b) => (b[revCol] || 0) - (a[revCol] || 0))
        .slice(0, 200)
        .forEach(r => {
          const val = r[revCol];
          const med = r[revMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(diff)}</td>
          `;
          revBody.appendChild(tr);
        });

      // EBITDA
      const ebitdaBody = document.getElementById("growth-ebitda-body");
      ebitdaBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[ebitdaCol], filters.ebitda.op, filters.ebitda.threshold))
        .sort((a, b) => (b[ebitdaCol] || 0) - (a[ebitdaCol] || 0))
        .slice(0, 200)
        .forEach(r => {
          const val = r[ebitdaCol];
          const med = r[ebitdaMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(diff)}</td>
          `;
          ebitdaBody.appendChild(tr);
        });

      // EPS
      const epsBody = document.getElementById("growth-eps-body");
      epsBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[epsCol], filters.eps.op, filters.eps.threshold))
        .sort((a, b) => (b[epsCol] || 0) - (a[epsCol] || 0))
        .slice(0, 200)
        .forEach(r => {
          const val = r[epsCol];
          const med = r[epsMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(diff)}</td>
          `;
          epsBody.appendChild(tr);
        });

      // Summary
      const summaryBody = document.getElementById("growth-summary-body");
      summaryBody.innerHTML = "";
      rows
        .filter(r =>
          passComparator(r[revCol], filters.rev.op, filters.rev.threshold) &&
          passComparator(r[ebitdaCol], filters.ebitda.op, filters.ebitda.threshold) &&
          passComparator(r[epsCol], filters.eps.op, filters.eps.threshold)
        )
        .sort((a, b) => {
          const aSum = (a[revCol] || 0) + (a[ebitdaCol] || 0) + (a[epsCol] || 0);
          const bSum = (b[revCol] || 0) + (b[ebitdaCol] || 0) + (b[epsCol] || 0);
          return bSum - aSum;
        })
        .slice(0, 200)
        .forEach(r => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(r[revCol])}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(r[ebitdaCol])}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(r[epsCol])}</td>
          `;
          summaryBody.appendChild(tr);
        });
    }

    // ---------------- VALUATION FILTERS ----------------
    function getValuationFilterState() {
      return {
        pe: {
          op: document.getElementById("val-pe-op").value,
          threshold: parseFloat(document.getElementById("val-pe-threshold").value) || 0,
        },
        pb: {
          op: document.getElementById("val-pb-op").value,
          threshold: parseFloat(document.getElementById("val-pb-threshold").value) || 0,
        },
        ps: {
          op: document.getElementById("val-ps-op").value,
          threshold: parseFloat(document.getElementById("val-ps-threshold").value) || 0,
        },
      };
    }

    // ---------- VALUATION ----------
    function renderValuation() {
      const filters = getValuationFilterState();
      const rows = getFilteredRows();
      const periodKey = getCurrentPeriodKey();

      // Determine columns
      let peCol, pbCol, psCol, peMedCol, pbMedCol, psMedCol;
      if (periodKey === "2Y") {
        peCol = "PE_Avg2";
        pbCol = "PB_Avg2";
        psCol = "PS_Avg2";
        peMedCol = "Sub_Sector_Med_PE_Avg2";
        pbMedCol = "Sub_Sector_Med_PB_Avg2";
        psMedCol = "Sub_Sector_Med_PS_Avg2";
      } else if (periodKey === "3Y") {
        peCol = "PE_Avg3";
        pbCol = "PB_Avg3";
        psCol = "PS_Avg3";
        peMedCol = "Sub_Sector_Med_PE_Avg3";
        pbMedCol = "Sub_Sector_Med_PB_Avg3";
        psMedCol = "Sub_Sector_Med_PS_Avg3";
      } else {
        peCol = "PE_" + periodKey;
        pbCol = "PB_" + periodKey;
        psCol = "PS_" + periodKey;
        peMedCol = "Sub_Sector_Med_PE_" + periodKey;
        pbMedCol = "Sub_Sector_Med_PB_" + periodKey;
        psMedCol = "Sub_Sector_Med_PS_" + periodKey;
      }

      // PE
      const peBody = document.getElementById("val-pe-body");
      peBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[peCol], filters.pe.op, filters.pe.threshold))
        .sort((a, b) => (a[peCol] || 999) - (b[peCol] || 999))
        .slice(0, 200)
        .forEach(r => {
          const val = r[peCol];
          const med = r[peMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtNum(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(diff)}</td>
          `;
          peBody.appendChild(tr);
        });

      // P/B
      const pbBody = document.getElementById("val-pb-body");
      pbBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[pbCol], filters.pb.op, filters.pb.threshold))
        .sort((a, b) => (a[pbCol] || 999) - (b[pbCol] || 999))
        .slice(0, 200)
        .forEach(r => {
          const val = r[pbCol];
          const med = r[pbMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtNum(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(diff)}</td>
          `;
          pbBody.appendChild(tr);
        });

      // P/S
      const psBody = document.getElementById("val-ps-body");
      psBody.innerHTML = "";
      rows
        .filter(r => passComparator(r[psCol], filters.ps.op, filters.ps.threshold))
        .sort((a, b) => (a[psCol] || 999) - (b[psCol] || 999))
        .slice(0, 200)
        .forEach(r => {
          const val = r[psCol];
          const med = r[psMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtNum(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtNum(diff)}</td>
          `;
          psBody.appendChild(tr);
        });
    }

    // ---------------- MARGIN FILTERS ----------------
    function getMarginFilterState() {
      return {
        ebitda: {
          op: document.getElementById("margin-ebitda-op").value,
          threshold: parseFloat(document.getElementById("margin-ebitda-threshold").value) || 0,
        },
        pat: {
          op: document.getElementById("margin-pat-op").value,
          threshold: parseFloat(document.getElementById("margin-pat-threshold").value) || 0,
        },
      };
    }

    // ---------- MARGIN ----------
    function renderMargin() {
      const filters = getMarginFilterState();
      const rows = getFilteredRows();
      const periodKey = getCurrentPeriodKey();

      const ebitdaBody = document.getElementById("margin-ebitda-body");
      const patBody = document.getElementById("margin-pat-body");
      ebitdaBody.innerHTML = "";
      patBody.innerHTML = "";

      // Determine columns
      let ebitdaCol, patCol, ebitdaMedCol, patMedCol;
      if (periodKey === "2Y") {
        ebitdaCol = "EBITDA_Margin_CAGR2";
        patCol = "PAT_Margin_CAGR2";
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_Margin_CAGR2";
        patMedCol = "Sub_Sector_Med_PAT_Margin_CAGR2";
      } else if (periodKey === "3Y") {
        ebitdaCol = "EBITDA_Margin_CAGR3";
        patCol = "PAT_Margin_CAGR3";
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_Margin_CAGR3";
        patMedCol = "Sub_Sector_Med_PAT_Margin_CAGR3";
      } else {
        ebitdaCol = "EBITDA_MExp_" + periodKey;
        patCol = "PAT_MExp_" + periodKey;
        ebitdaMedCol = "Sub_Sector_Med_EBITDA_MExp_" + periodKey;
        patMedCol = "Sub_Sector_Med_PAT_MExp_" + periodKey;
      }

      // EBITDA Margin
      rows
        .filter(r => passComparator(r[ebitdaCol], filters.ebitda.op, filters.ebitda.threshold))
        .sort((a, b) => (b[ebitdaCol] || 0) - (a[ebitdaCol] || 0))
        .slice(0, 200)
        .forEach(r => {
          const val = r[ebitdaCol];
          const med = r[ebitdaMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(diff)}</td>
          `;
          ebitdaBody.appendChild(tr);
        });

      // PAT Margin
      rows
        .filter(r => passComparator(r[patCol], filters.pat.op, filters.pat.threshold))
        .sort((a, b) => (b[patCol] || 0) - (a[patCol] || 0))
        .slice(0, 200)
        .forEach(r => {
          const val = r[patCol];
          const med = r[patMedCol];
          const diff = (val != null && med != null) ? val - med : null;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-800/70";
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(val)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(med)}</td>
            <td class="pr-2 py-0.5 text-center">${fmtPct(diff)}</td>
          `;
          patBody.appendChild(tr);
        });
    }

    // ---------------- GSM FILTERS ----------------
    function getGsmFilterState() {
      return {
        rev: parseFloat(document.getElementById("gsm-rev-threshold").value) || 0,
        eps: parseFloat(document.getElementById("gsm-eps-threshold").value) || 0,
        pe: parseFloat(document.getElementById("gsm-pe-threshold").value) || 0,
      };
    }

    // ---------- GSM ----------
    function renderGsm() {
      const body = document.getElementById("gsm-body");
      const headerRow = document.getElementById("gsm-header-row");
      body.innerHTML = "";
      headerRow.innerHTML = "";

      const filters = getGsmFilterState();
      const sector = getCurrentSector();
      const sectorIsAll = (sector === null);

      const periodKey = getCurrentPeriodKey();

      // Determine columns based on period
      let revCol, epsCol, peCol;
      if (periodKey === "2Y") {
        revCol = "Rev_G_CAGR2";
        epsCol = "EPS_G_CAGR2";
        peCol = "PE_Avg2";
      } else if (periodKey === "3Y") {
        revCol = "Rev_G_CAGR3";
        epsCol = "EPS_G_CAGR3";
        peCol = "PE_Avg3";
      } else {
        revCol = "Rev_G_" + periodKey;
        epsCol = "EPS_G_" + periodKey;
        peCol = "PE_" + periodKey;
      }

      // Header: always generic labels
      if (sectorIsAll) {
        headerRow.innerHTML = `
          <th class="pr-2">Company</th>
          <th class="pr-2 text-left">Sector</th>
          <th class="pr-2 text-center">Rev Growth</th>
          <th class="pr-2 text-center">EPS Growth</th>
          <th class="pr-2 text-center">PE</th>
        `;
      } else {
        headerRow.innerHTML = `
          <th class="pr-2">Company</th>
          <th class="pr-2 text-center">Rev Growth</th>
          <th class="pr-2 text-center">EPS Growth</th>
          <th class="pr-2 text-center">PE</th>
        `;
      }

      const filtered = getFilteredRows()
        .filter(r => {
          const rev = r[revCol];
          const eps = r[epsCol];
          const pe = r[peCol];

          const passGrowth =
            ((rev != null && !isNaN(rev) && rev >= filters.rev) ||
             (eps != null && !isNaN(eps) && eps >= filters.eps));

          const passPe = (pe != null && !isNaN(pe) && pe <= filters.pe);

          return passGrowth && passPe;
        })
        .sort((a, b) => {
          const aRev = a[revCol] || 0;
          const bRev = b[revCol] || 0;
          if (bRev !== aRev) return bRev - aRev;
          const aEps = a[epsCol] || 0;
          const bEps = b[epsCol] || 0;
          return bEps - aEps;
        })
        .slice(0, 500);

      filtered.forEach(r => {
        const rev = r[revCol];
        const eps = r[epsCol];
        const pe = r[peCol];

        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-800/70";

        if (sectorIsAll) {
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-left">${r.Sector || ""}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(rev)}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(eps)}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtNum(pe)}</td>
          `;
        } else {
          tr.innerHTML = `
            <td class="pr-2 py-0.5">${r.Company}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(rev)}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtPct(eps)}</td>
            <td class="pr-2 py-0.5 text-center font-medium">${fmtNum(pe)}</td>
          `;
        }

        body.appendChild(tr);
      });
    }

    // ---------------- LIVE FILTER EVENTS ----------------
    function setupFilterEvents() {
      const ids = [
        "growth-rev-op", "growth-rev-threshold",
        "growth-ebitda-op", "growth-ebitda-threshold",
        "growth-eps-op", "growth-eps-threshold",
        "val-pe-op", "val-pe-threshold",
        "val-pb-op", "val-pb-threshold",
        "val-ps-op", "val-ps-threshold",
        "margin-ebitda-op", "margin-ebitda-threshold",
        "margin-pat-op", "margin-pat-threshold",
        "gsm-rev-threshold", "gsm-eps-threshold", "gsm-pe-threshold",
        "period-select", "marketcap-select"
      ];

      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const eventName = el.tagName === "SELECT" ? "change" : "input";
        el.addEventListener(eventName, () => {
          if (id === "period-select") {
            updatePeriodLabel();
          }
          renderAll();
        });
      });

      // Sector select with special logic
      document.getElementById("sector-select").addEventListener("change", () => {
        updateSubSectorDropdown();
        renderAll();
      });

      // Sub-Sector select with reverse selection logic
      document.getElementById("subsector-select").addEventListener("change", () => {
        const subSector = getCurrentSubSector();
        const currentSector = getCurrentSector();
        
        if (subSector && !currentSector) {
          // If sub-sector is selected but sector is "All", auto-select the parent sector
          const parentSector = getSectorForSubSector(subSector);
          if (parentSector) {
            document.getElementById("sector-select").value = parentSector;
            updateSubSectorDropdown();
          }
        }
        renderAll();
      });
    }

    // ---------------- EXCEL DOWNLOAD ----------------
    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const tabContainer = document.getElementById(`tab-${currentTab}`);
      if (!tabContainer) return;

      const sections = tabContainer.querySelectorAll("section[data-section]");

      sections.forEach(sec => {
        const titleEl = sec.querySelector("h2");
        let sheetName = titleEl ? titleEl.innerText.trim() : sec.dataset.section;
        if (!sheetName) sheetName = "Sheet";
        if (sheetName.length > 31) {
          sheetName = sheetName.slice(0, 31);
        }

        const table = sec.querySelector("table");
        if (!table) return;

        const headers = Array.from(table.querySelectorAll("thead th"))
          .map(th => th.innerText.trim());

        const rowsAoA = [headers];

        const tbody = table.querySelector("tbody");
        Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
          const cells = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.trim());
          if (cells.length) rowsAoA.push(cells);
        });

        const ws = XLSX.utils.aoa_to_sheet(rowsAoA);
        XLSX.utils.book_append_sheet(wb, ws, sheetName || "Sheet");
      });

      XLSX.writeFile(wb, "Broker_Consensus.xlsx");
    }

    // ---------------- INIT ----------------
    Papa.parse("dashboard_data.csv?v=" + new Date().getTime(), {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        allRows = results.data.filter(r => r.Company);

        // Build sector-subsector mapping
        buildSectorSubSectorMapping();

        // Populate Sector dropdown
        const sectors = [...new Set(allRows.map(r => r.Sector))].filter(Boolean).sort();
        const sectorSelect = document.getElementById("sector-select");
        sectorSelect.innerHTML =
          `<option value="All" selected>All</option>` +
          sectors.map(s => `<option value="${s}">${s}</option>`).join("");

        // Populate Sub-Sector dropdown (initially all)
        updateSubSectorDropdown();

        // Populate Market Cap dropdown
        const marketCaps = [...new Set(allRows.map(r => r.Market_Cap))].filter(Boolean).sort();
        const marketCapSelect = document.getElementById("marketcap-select");
        marketCapSelect.innerHTML =
          `<option value="All" selected>All</option>` +
          marketCaps.map(m => `<option value="${m}">${m}</option>`).join("");

        setupTabs();
        setupFilterEvents();
        document.getElementById("download-excel").addEventListener("click", downloadExcel);

        updatePeriodLabel();
        renderAll();
      },
    });
  </script>
</body>
</html>
