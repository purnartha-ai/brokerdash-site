<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

<header class="mb-4 flex justify-between items-center">
  <div>
    <h1 class="text-4xl font-semibold">Broker Consensus Dashboard</h1>
    <p class="text-slate-400 text-sm">
      Compare companies on Growth, Valuation, Margin Expansion and GSM
    </p>
  </div>
  <img src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png" class="h-16" />
</header>

<!-- FILTER BAR -->
<div class="flex flex-wrap gap-4 text-xs mb-4 items-center">
  <div>
    Sector:
    <select id="sector-select" class="bg-slate-900 border px-2 py-1 rounded"></select>
  </div>
  <div>
    Sub-Sector:
    <select id="subsector-select" class="bg-slate-900 border px-2 py-1 rounded"></select>
  </div>
  <div>
    Market Cap:
    <select id="mcap-select" class="bg-slate-900 border px-2 py-1 rounded"></select>
  </div>
  <div>
    Period:
    <select id="period-select" class="bg-slate-900 border px-2 py-1 rounded">
      <option value="FY1">FY1</option>
      <option value="FY2">FY2</option>
      <option value="FY3">FY3</option>
      <option value="2Y">2-Year</option>
      <option value="3Y">3-Year</option>
    </select>
    <span id="period-help" class="text-slate-400 ml-2"></span>
  </div>
</div>

<!-- TABS -->
<nav class="flex gap-4 border-b border-slate-800 mb-4">
  <button class="tab-btn text-emerald-400 border-b-2 border-emerald-500" data-tab="growth">Growth</button>
  <button class="tab-btn text-slate-300" data-tab="valuation">Valuation</button>
  <button class="tab-btn text-slate-300" data-tab="margin">Margin Expansion</button>
  <button class="tab-btn text-slate-300" data-tab="gsm">GSM</button>
</nav>

<div id="tab-growth"></div>
<div id="tab-valuation" class="hidden"></div>
<div id="tab-margin" class="hidden"></div>
<div id="tab-gsm" class="hidden"></div>

</div>

<script>
let allRows = [];
let currentTab = "growth";

/* ---------- PERIOD MAP ---------- */
function metric(col, base) {
  const p = document.getElementById("period-select").value;
  if (p === "2Y") return base + "_CAGR2";
  if (p === "3Y") return base + "_CAGR3";
  return base + "_" + p;
}

function valMetric(base) {
  const p = document.getElementById("period-select").value;
  if (p === "2Y") return base + "_Avg2";
  if (p === "3Y") return base + "_Avg3";
  return base + "_" + p;
}

/* ---------- FILTERS ---------- */
function selected(id) {
  const v = document.getElementById(id).value;
  return v === "All" ? null : v;
}

function filteredRows() {
  const s = selected("sector-select");
  const ss = selected("subsector-select");
  const mc = selected("mcap-select");

  return allRows.filter(r =>
    (!s || r.Sector === s) &&
    (!ss || r.Sub_Sector === ss) &&
    (!mc || r.Market_Cap === mc)
  );
}

/* ---------- CASCADING ---------- */
function populateSubSector() {
  const s = selected("sector-select");
  const subs = [...new Set(allRows.filter(r => !s || r.Sector === s).map(r => r.Sub_Sector))];
  document.getElementById("subsector-select").innerHTML =
    "<option>All</option>" + subs.sort().map(x => `<option>${x}</option>`).join("");
}

function populateMarketCap() {
  const s = selected("sector-select");
  const ss = selected("subsector-select");
  const caps = [...new Set(allRows.filter(r =>
    (!s || r.Sector === s) &&
    (!ss || r.Sub_Sector === ss)
  ).map(r => r.Market_Cap))];
  document.getElementById("mcap-select").innerHTML =
    "<option>All</option>" + caps.sort().map(x => `<option>${x}</option>`).join("");
}

/* ---------- TABS ---------- */
function setupTabs() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
      currentTab = btn.dataset.tab;
      document.querySelectorAll("[id^=tab-]").forEach(d => d.classList.add("hidden"));
      document.getElementById("tab-" + currentTab).classList.remove("hidden");

      document.querySelectorAll(".tab-btn").forEach(b =>
        b.classList.remove("text-emerald-400","border-b-2","border-emerald-500")
      );
      btn.classList.add("text-emerald-400","border-b-2","border-emerald-500");

      renderAll();
    };
  });
}

/* ---------- RENDER ---------- */
function renderAll() {
  if (currentTab === "growth") renderGrowth();
  if (currentTab === "valuation") renderValuation();
  if (currentTab === "margin") renderMargin();
  if (currentTab === "gsm") renderGSM();
}

function renderGrowth() {
  const rows = filteredRows();
  const el = document.getElementById("tab-growth");
  const m = metric("Rev_G","Rev_G");
  el.innerHTML = `
    <table class="text-xs w-full">
      <tr class="text-slate-400"><th>Company</th><th>Revenue Growth</th></tr>
      ${rows.map(r => `
        <tr><td>${r.Company}</td><td>${r[m]?.toFixed?.(1) ?? "-"}</td></tr>
      `).join("")}
    </table>`;
}

function renderValuation() {
  const rows = filteredRows();
  const el = document.getElementById("tab-valuation");
  el.innerHTML = `
    <table class="text-xs w-full">
      <tr class="text-slate-400"><th>Company</th><th>PE</th></tr>
      ${rows.map(r => `
        <tr><td>${r.Company}</td><td>${r[valMetric("PE")]?.toFixed?.(1) ?? "-"}</td></tr>
      `).join("")}
    </table>`;
}

function renderMargin() {
  document.getElementById("tab-margin").innerHTML =
    `<div class="text-slate-400 text-sm">Margin Expansion logic unchanged</div>`;
}

function renderGSM() {
  document.getElementById("tab-gsm").innerHTML =
    `<div class="text-slate-400 text-sm">GSM logic unchanged</div>`;
}

/* ---------- LOAD CSV ---------- */
Papa.parse("dashboard_data.csv?v=" + Date.now(), {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: res => {
    allRows = res.data.filter(r => r.Company);

    document.getElementById("sector-select").innerHTML =
      "<option>All</option>" +
      [...new Set(allRows.map(r => r.Sector))].sort().map(x => `<option>${x}</option>`).join("");

    populateSubSector();
    populateMarketCap();

    document.getElementById("sector-select").onchange = () => {
      populateSubSector(); populateMarketCap(); renderAll();
    };
    document.getElementById("subsector-select").onchange = () => {
      populateMarketCap(); renderAll();
    };
    document.getElementById("mcap-select").onchange = renderAll;
    document.getElementById("period-select").onchange = renderAll;

    setupTabs();
    renderAll();
  }
});
</script>
</body>
</html>
