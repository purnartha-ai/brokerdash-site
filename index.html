<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

<!-- ================= HEADER ================= -->
<header class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between">
  <div>
    <h1 class="text-4xl font-semibold mb-1">Broker Consensus Dashboard</h1>
    <p class="text-slate-300 text-sm">
      Compare companies on Growth, Valuation, Margin Expansion and GSM.
    </p>
  </div>
  <img src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png"
       class="h-20 mt-3 md:mt-0" />
</header>

<!-- ================= FILTER BAR ================= -->
<div class="mb-4 flex flex-wrap items-center gap-4 text-xs">

  <!-- Sector -->
  <div class="flex items-center gap-2">
    <span class="text-slate-300">Sector:</span>
    <select id="sector-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
  </div>

  <!-- Sub-Sector -->
  <div class="flex items-center gap-2">
    <span class="text-slate-300">Sub-Sector:</span>
    <select id="subsector-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
  </div>

  <!-- Market Cap -->
  <div class="flex items-center gap-2">
    <span class="text-slate-300">Market Cap:</span>
    <select id="mcap-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
  </div>

  <!-- Period -->
  <div class="flex items-center gap-2 ml-4">
    <span class="text-slate-300">Period:</span>
    <select id="period-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
      <option value="FY1" selected>FY1</option>
      <option value="FY2">FY2</option>
      <option value="FY3">FY3</option>
      <option value="2Y">2-Year</option>
      <option value="3Y">3-Year</option>
    </select>
    <span id="period-help" class="text-slate-400 text-[11px]"></span>
  </div>

  <div class="ml-auto">
    <button id="download-excel"
            class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-xs">
      Download Excel
    </button>
  </div>
</div>

<!-- ================= TABS ================= -->
<div class="mb-4 border-b border-slate-800">
  <nav class="flex gap-4 text-sm">
    <button class="tab-btn py-2 border-b-2 border-emerald-500 text-emerald-400" data-tab="growth">Growth</button>
    <button class="tab-btn py-2 border-b-2 border-transparent text-slate-300" data-tab="valuation">Valuation</button>
    <button class="tab-btn py-2 border-b-2 border-transparent text-slate-300" data-tab="margin">Margin Expansion</button>
    <button class="tab-btn py-2 border-b-2 border-transparent text-slate-300" data-tab="gsm">GSM</button>
  </nav>
</div>

<div id="tab-growth"></div>
<div id="tab-valuation" class="hidden"></div>
<div id="tab-margin" class="hidden"></div>
<div id="tab-gsm" class="hidden"></div>

</div>

<!-- ================= JS ================= -->
<script>
let allRows = [];
let currentTab = "growth";

/* ---------------- PERIOD SUFFIX ---------------- */
function getPeriodSuffix(tab, key) {
  if (key === "2Y") return tab === "valuation" ? "Avg2" : "CAGR2";
  if (key === "3Y") return tab === "valuation" ? "Avg3" : "CAGR3";
  return key;
}

/* ---------------- FILTERING ---------------- */
function getFilteredRows() {
  const s = sectorSelect.value;
  const ss = subSectorSelect.value;
  const mc = mcapSelect.value;

  return allRows.filter(r => {
    if (s !== "All" && r.Sector !== s) return false;
    if (ss !== "All" && r.Sub_Sector !== ss) return false;
    if (mc !== "All" && r.Market_Cap !== mc) return false;
    return true;
  });
}

/* ---------------- CASCADING DROPDOWNS ---------------- */
function populateSector() {
  const vals = [...new Set(allRows.map(r => r.Sector))].sort();
  sectorSelect.innerHTML = `<option>All</option>` + vals.map(v => `<option>${v}</option>`).join("");
}

function populateSubSector() {
  const s = sectorSelect.value;
  const vals = [...new Set(allRows.filter(r => s==="All"||r.Sector===s).map(r => r.Sub_Sector))].sort();
  subSectorSelect.innerHTML = `<option>All</option>` + vals.map(v => `<option>${v}</option>`).join("");
}

function populateMarketCap() {
  const s = sectorSelect.value;
  const ss = subSectorSelect.value;
  const vals = [...new Set(allRows.filter(r =>
    (s==="All"||r.Sector===s) &&
    (ss==="All"||r.Sub_Sector===ss)
  ).map(r => r.Market_Cap))].sort();

  mcapSelect.innerHTML = `<option>All</option>` + vals.map(v => `<option>${v}</option>`).join("");
}

/* ---------------- TAB SWITCH ---------------- */
function setupTabs() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
      currentTab = btn.dataset.tab;
      document.querySelectorAll("[id^='tab-']").forEach(d => d.classList.add("hidden"));
      document.getElementById(`tab-${currentTab}`).classList.remove("hidden");

      document.querySelectorAll(".tab-btn").forEach(b=>{
        b.classList.remove("border-emerald-500","text-emerald-400");
        b.classList.add("border-transparent","text-slate-300");
      });
      btn.classList.add("border-emerald-500","text-emerald-400");

      renderAll();
    };
  });
}

/* ---------------- MAIN RENDER ---------------- */
  function renderAll() {
    const rows = getFilteredRows();
    const periodKey = periodSelect.value;

    if (currentTab === "growth") {
      renderGrowth(rows, periodKey);
    }

    if (currentTab === "valuation") {
      renderValuation(rows, periodKey);
    }

    if (currentTab === "margin") {
      renderMarginExpansion(rows, periodKey);
    }

    if (currentTab === "gsm") {
      renderGSM(rows, periodKey);
    }
  }

/* ---------------- LOAD CSV ---------------- */
const sectorSelect = document.getElementById("sector-select");
const subSectorSelect = document.getElementById("subsector-select");
const mcapSelect = document.getElementById("mcap-select");

Papa.parse("dashboard_data.csv", {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: res => {
    allRows = res.data.filter(r => r.Company);
    populateSector();
    populateSubSector();
    populateMarketCap();
    setupTabs();
    renderAll();
  }
});

sectorSelect.onchange = () => { populateSubSector(); populateMarketCap(); renderAll(); };
subSectorSelect.onchange = () => { populateMarketCap(); renderAll(); };
mcapSelect.onchange = renderAll;

</script>
</body>
</html>

