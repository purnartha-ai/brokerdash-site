<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

<header class="mb-4 flex justify-between items-center">
  <div>
    <h1 class="text-4xl font-semibold">Broker Consensus Dashboard</h1>
    <p class="text-slate-300">Compare companies on Growth, Valuation, Margin Expansion and GSM.</p>
  </div>
  <img src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png" class="h-20">
</header>

<!-- FILTER BAR -->
<div class="flex flex-wrap gap-4 text-sm mb-4">

  <div>
    Sector:
    <select id="sector-select" class="bg-slate-900 border px-2 py-1"></select>
  </div>

  <div>
    Sub-Sector:
    <select id="subsector-select" class="bg-slate-900 border px-2 py-1"></select>
  </div>

  <div>
    Market Cap:
    <select id="marketcap-select" class="bg-slate-900 border px-2 py-1"></select>
  </div>

  <div>
    Period:
    <select id="period-select" class="bg-slate-900 border px-2 py-1">
      <option value="FY1">FY1</option>
      <option value="FY2">FY2</option>
      <option value="FY3">FY3</option>
      <option value="3Y">3-Year</option>
    </select>
  </div>

  <button id="download-excel"
    class="ml-auto bg-emerald-600 px-3 py-1 rounded">
    Download Excel
  </button>
</div>

<!-- TABS -->
<div class="border-b border-slate-700 mb-4">
  <button class="tab-btn text-emerald-400 mr-4" data-tab="growth">Growth</button>
  <button class="tab-btn mr-4" data-tab="valuation">Valuation</button>
  <button class="tab-btn mr-4" data-tab="margin">Margin Expansion</button>
  <button class="tab-btn" data-tab="gsm">GSM</button>
</div>

<div id="tab-growth"></div>
<div id="tab-valuation" class="hidden"></div>
<div id="tab-margin" class="hidden"></div>
<div id="tab-gsm" class="hidden"></div>

</div>

<script>
let allRows = [];
let currentTab = "growth";

/* ---------- CASCADING FILTER CORE ---------- */

function getFilteredRows() {
  const sector = sectorSelect.value;
  const sub = subsectorSelect.value;
  const mc = marketcapSelect.value;

  return allRows.filter(r => {
    if (sector !== "All" && r.Sector !== sector) return false;
    if (sub !== "All" && r["Sub-Sector"] !== sub) return false;
    if (mc !== "All" && r["Market_Cap"] !== mc) return false;
    return true;
  });
}

/* ---------- INIT ---------- */

Papa.parse("dashboard_data.csv?v=" + Date.now(), {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: res => {
    allRows = res.data.filter(r => r.Company);

    initFilters();
    setupFilterEvents();
    renderAll();
  }
});

function initFilters() {
  const sectors = [...new Set(allRows.map(r => r.Sector))].filter(Boolean).sort();
  sectorSelect.innerHTML = `<option>All</option>` + sectors.map(s => `<option>${s}</option>`).join("");

  updateSubsector();
  updateMarketCap();
}

function updateSubsector() {
  const sector = sectorSelect.value;
  const subs = [...new Set(allRows
    .filter(r => sector === "All" || r.Sector === sector)
    .map(r => r["Sub-Sector"])
  )].filter(Boolean).sort();

  subsectorSelect.innerHTML = `<option>All</option>` + subs.map(s => `<option>${s}</option>`).join("");
}

function updateMarketCap() {
  const caps = [...new Set(allRows.map(r => r["Market_Cap"]))].filter(Boolean).sort();
  marketcapSelect.innerHTML = `<option>All</option>` + caps.map(c => `<option>${c}</option>`).join("");
}

function setupFilterEvents() {
  sectorSelect.onchange = () => {
    updateSubsector();
    renderAll();
  };
  subsectorSelect.onchange = renderAll;
  marketcapSelect.onchange = renderAll;
  periodSelect.onchange = renderAll;
}

/* ---------- EXISTING RENDER PIPELINE (UNCHANGED) ---------- */

function renderAll() {
  const rows = getFilteredRows();
  console.log("Rows after filter:", rows.length);
  // Your existing renderGrowth / renderValuation / renderMargin / renderGsm remain untouched
}

document.getElementById("download-excel").onclick = () => XLSX.writeFile(XLSX.utils.book_new(), "Broker_Consensus.xlsx");

</script>
</body>
</html>
