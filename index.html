<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- HEADER -->
  <header class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-4xl font-semibold mb-1">Broker Consensus Dashboard</h1>
      <p class="text-slate-300">Compare companies across Growth, Valuation, Margin Expansion and GSM</p>
    </div>
    <img src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png"
         class="h-24 mt-3 md:mt-0">
  </header>

  <!-- FILTER BAR -->
  <div class="mb-4 flex flex-wrap gap-3 text-xs items-center">

    <!-- SECTOR -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Sector:</span>
      <select id="sector-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
    </div>

    <!-- SUB SECTOR -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Sub-Sector:</span>
      <select id="subsector-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
    </div>

    <!-- MARKET CAP -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Market Cap:</span>
      <select id="marketcap-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1"></select>
    </div>

    <!-- PERIOD -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Period:</span>
      <select id="period-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
        <option value="FY1">FY1</option>
        <option value="FY2">FY2</option>
        <option value="FY3">FY3</option>
        <option value="3Y">3-Year</option>
      </select>
    </div>

    <div class="ml-auto">
      <button id="download-excel"
              class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded">
        Download Excel
      </button>
    </div>
  </div>

  <!-- TABS (UNCHANGED) -->
  <div class="mb-4 border-b border-slate-800">
    <nav class="flex gap-4 text-sm">
      <button class="tab-btn border-b-2 border-emerald-500 text-emerald-400" data-tab="growth">Growth</button>
      <button class="tab-btn text-slate-300" data-tab="valuation">Valuation</button>
      <button class="tab-btn text-slate-300" data-tab="margin">Margin Expansion</button>
      <button class="tab-btn text-slate-300" data-tab="gsm">GSM</button>
    </nav>
  </div>

  <!-- ALL YOUR EXISTING TAB CONTENT REMAINS UNCHANGED -->
  <!-- (Growth / Valuation / Margin / GSM sections stay exactly same as your file) -->
  <!-- =============================================================== -->
  <!-- DO NOT MODIFY ANY TABLE STRUCTURE BELOW THIS LINE -->
  <!-- =============================================================== -->

  <!-- YOUR EXISTING TAB CONTENT GOES HERE -->
  <!-- (Omitted here for brevity – KEEP EXACTLY AS YOU HAVE IT) -->

</div>

<script>
let allRows = [];
let currentTab = "growth";

/* ================= FILTER HELPERS ================= */

function getVal(id) {
  const v = document.getElementById(id).value;
  return v === "All" ? null : v;
}

function getFilteredRows() {
  const sector = document.getElementById("sector-select")?.value || "All";
  const subSector = document.getElementById("subsector-select")?.value || "All";
  const marketCap = document.getElementById("marketcap-select")?.value || "All";

  return allRows.filter(r => {
    if (sector !== "All" && r.Sector !== sector) return false;
    if (subSector !== "All" && r["Sub-Sector"] !== subSector) return false;
    if (marketCap !== "All" && r["Market Cap"] !== marketCap) return false;
    return true;
  });
}

/* ================= CASCADING DROPDOWNS ================= */

function populateDropdown(el, values) {
  el.innerHTML =
    `<option value="All">All</option>` +
    values.map(v => `<option value="${v}">${v}</option>`).join("");
}

function refreshSubSectorOptions() {
  const sector = getVal("sector-select");
  const rows = sector ? allRows.filter(r => r.Sector === sector) : allRows;
  const subs = [...new Set(rows.map(r => r["Sub-Sector"]).filter(Boolean))].sort();
  populateDropdown(document.getElementById("subsector-select"), subs);
}

function refreshMarketCapOptions() {
  const sector = getVal("sector-select");
  const sub = getVal("subsector-select");

  let rows = allRows;
  if (sector) rows = rows.filter(r => r.Sector === sector);
  if (sub) rows = rows.filter(r => r["Sub-Sector"] === sub);

  const mcs = [...new Set(rows.map(r => r["Market Cap"]).filter(Boolean))].sort();
  populateDropdown(document.getElementById("marketcap-select"), mcs);
}

/* ================= INIT ================= */

Papa.parse("dashboard_data.csv?v=" + Date.now(), {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: function(res) {
    allRows = res.data.filter(r => r.Company);

    const sectors = [...new Set(allRows.map(r => r.Sector).filter(Boolean))].sort();
    populateDropdown(document.getElementById("sector-select"), sectors);

    refreshSubSectorOptions();
    refreshMarketCapOptions();

    ["sector-select", "subsector-select", "marketcap-select", "period-select"]
      .forEach(id => {
        document.getElementById(id).addEventListener("change", () => {
          refreshSubSectorOptions();
          refreshMarketCapOptions();
          renderAll();   // EXISTING FUNCTION – untouched
        });
      });

    document.getElementById("download-excel").onclick = downloadExcel;
    setupTabs();        // EXISTING
    setupFilterEvents();// EXISTING
    renderAll();        // EXISTING
  }
});
</script>

</body>
</html>

