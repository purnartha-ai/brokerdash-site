<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Broker Consensus Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-50 min-h-screen">
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- Header -->
  <header class="mb-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-4xl font-semibold tracking-tight mb-1">
        Broker Consensus Dashboard
      </h1>
      <p class="text-slate-300 text-sm">
        Compare companies on Growth, Valuation, Margin Expansion and GSM.
      </p>
    </div>

    <img
      src="https://purnartha-ai.github.io/brokerdash-site/White Purnartha logo-01.png"
      class="h-24"
    />
  </header>

  <!-- Top Controls -->
  <div class="mb-4 flex flex-wrap items-center gap-3 text-xs">

    <!-- Sector -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Sector:</span>
      <select id="sector-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
      </select>
    </div>

    <!-- Sub-Sector -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Sub-Sector:</span>
      <select id="subsector-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
      </select>
    </div>

    <!-- Market Cap -->
    <div class="flex items-center gap-2">
      <span class="text-slate-300">Market Cap:</span>
      <select id="mcap-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
      </select>
    </div>

    <!-- Period -->
    <div class="flex items-center gap-2 ml-4">
      <span class="text-slate-300">Period:</span>
      <select id="period-select"
              class="bg-slate-900 border border-slate-700 rounded px-2 py-1">
        <option value="FY1" selected>FY1</option>
        <option value="FY2">FY2</option>
        <option value="FY3">FY3</option>
        <option value="3Y">3-Year</option>
      </select>
      <span id="period-help" class="text-slate-400 text-[11px]"></span>
    </div>

    <!-- Download -->
    <button id="download-excel"
            class="ml-auto px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-xs">
      Download Excel
    </button>
  </div>

  <!-- Tabs -->
  <div class="mb-4 border-b border-slate-800">
    <nav class="flex gap-4 text-sm">
      <button class="tab-btn border-b-2 border-emerald-500 text-emerald-400" data-tab="growth">Growth</button>
      <button class="tab-btn border-b-2 border-transparent text-slate-300" data-tab="valuation">Valuation</button>
      <button class="tab-btn border-b-2 border-transparent text-slate-300" data-tab="margin">Margin Expansion</button>
      <button class="tab-btn border-b-2 border-transparent text-slate-300" data-tab="gsm">GSM</button>
    </nav>
  </div>

  <!-- TABS CONTENT (UNCHANGED FROM YOUR VERSION) -->
  <!-- Growth, Valuation, Margin, GSM sections remain EXACTLY as-is -->
  <!-- For brevity not repeated here, since you already confirmed they work -->

</div>

<script>
let allRows = [];
let currentTab = "growth";

/* =========================
   CASCADING FILTERS
========================= */

function getFilteredRows() {
  const sector = document.getElementById("sector-select").value;
  const subsector = document.getElementById("subsector-select").value;
  const mcap = document.getElementById("mcap-select").value;

  return allRows.filter(r => {
    if (sector !== "All" && r.Sector !== sector) return false;
    if (subsector !== "All" && r["Sub-Sector"] !== subsector) return false;
    if (mcap !== "All" && String(r["Market Cap"]) !== mcap) return false;
    return true;
  });
}

function updateSubSectorOptions() {
  const sector = document.getElementById("sector-select").value;

  const subs = [...new Set(
    allRows
      .filter(r => sector === "All" || r.Sector === sector)
      .map(r => r["Sub-Sector"])
      .filter(Boolean)
  )].sort();

  const sel = document.getElementById("subsector-select");
  sel.innerHTML = `<option value="All">All</option>` +
    subs.map(s => `<option value="${s}">${s}</option>`).join("");

  updateMarketCapOptions();
}

function updateMarketCapOptions() {
  const sector = document.getElementById("sector-select").value;
  const subsector = document.getElementById("subsector-select").value;

  const mcaps = [...new Set(
    allRows
      .filter(r =>
        (sector === "All" || r.Sector === sector) &&
        (subsector === "All" || r["Sub-Sector"] === subsector)
      )
      .map(r => String(r["Market Cap"]))
      .filter(Boolean)
  )].sort((a, b) => Number(a) - Number(b));

  const sel = document.getElementById("mcap-select");
  sel.innerHTML = `<option value="All">All</option>` +
    mcaps.map(m => `<option value="${m}">${m}</option>`).join("");
}

/* =========================
   DATA LOAD
========================= */

Papa.parse("dashboard_data.csv?v=" + Date.now(), {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: function (results) {
    allRows = results.data.filter(r => r.Company);

    const sectors = [...new Set(allRows.map(r => r.Sector))].filter(Boolean).sort();
    const sectorSelect = document.getElementById("sector-select");

    sectorSelect.innerHTML =
      `<option value="All">All</option>` +
      sectors.map(s => `<option value="${s}">${s}</option>`).join("");

    document.getElementById("subsector-select").innerHTML = `<option value="All">All</option>`;
    document.getElementById("mcap-select").innerHTML = `<option value="All">All</option>`;

    updateSubSectorOptions();

    sectorSelect.addEventListener("change", () => {
      updateSubSectorOptions();
      renderAll();
    });

    document.getElementById("subsector-select").addEventListener("change", () => {
      updateMarketCapOptions();
      renderAll();
    });

    document.getElementById("mcap-select").addEventListener("change", renderAll);

    setupTabs();
    setupFilterEvents();
    document.getElementById("download-excel").addEventListener("click", downloadExcel);

    updatePeriodLabel();
    renderAll();
  }
});
</script>

</body>
</html>
